<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase - Le Sillage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #8b4513;
            border-bottom: 3px solid #d4af37;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        button {
            background: #8b4513;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #6d3610;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .code {
            background: #1f2937;
            color: #10b981;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test de Configuration Supabase</h1>
        <p>Ce script teste votre configuration Supabase et les politiques RLS.</p>

        <div class="test-section">
            <h3>Configuration d√©tect√©e:</h3>
            <div id="config-info" class="test-result info">Chargement...</div>
        </div>

        <button onclick="runAllTests()">üöÄ Lancer tous les tests</button>
        <button onclick="testStorageUpload()">üì§ Tester l'upload d'images</button>
        <button onclick="testOrderCreation()">üõí Tester la cr√©ation de commande</button>

        <div id="test-results"></div>

        <div class="test-section" style="margin-top: 30px;">
            <h3>üìã Instructions de correction:</h3>
            <ol>
                <li>Si les tests √©chouent, ouvrez le fichier <strong>supabase-schema.sql</strong></li>
                <li>Copiez tout le contenu</li>
                <li>Allez dans Supabase Dashboard ‚Üí SQL Editor</li>
                <li>Collez et ex√©cutez le script</li>
                <li>Revenez ici et relancez les tests</li>
            </ol>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let supabase = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            initSupabase();
            displayConfig();
        });

        function initSupabase() {
            try {
                if (typeof window.Config !== 'undefined' && window.Config.Supabase) {
                    const config = window.Config.Supabase.get();
                    
                    if (!config.url || !config.anonKey) {
                        addResult('error', '‚ùå Configuration Supabase manquante dans js/config.js');
                        return false;
                    }

                    supabase = window.supabase.createClient(config.url, config.anonKey);
                    addResult('success', '‚úÖ Client Supabase initialis√© avec succ√®s');
                    return true;
                } else {
                    addResult('error', '‚ùå Fichier js/config.js non trouv√©');
                    return false;
                }
            } catch (error) {
                addResult('error', '‚ùå Erreur d\'initialisation: ' + error.message);
                return false;
            }
        }

        function displayConfig() {
            const config = window.Config?.Supabase?.get();
            const configInfo = document.getElementById('config-info');
            
            if (config && config.url && config.anonKey) {
                configInfo.innerHTML = `
                    <strong>URL:</strong> ${config.url}<br>
                    <strong>Anon Key:</strong> ${config.anonKey.substring(0, 30)}...<br>
                    <strong>Status:</strong> ‚úÖ Configur√©
                `;
                configInfo.className = 'test-result success';
            } else {
                configInfo.innerHTML = `
                    <strong>Status:</strong> ‚ùå Non configur√©<br>
                    Veuillez v√©rifier js/config.js
                `;
                configInfo.className = 'test-result error';
            }
        }

        async function runAllTests() {
            clearResults();
            addResult('info', 'üöÄ D√©but des tests...');
            
            await testConnection();
            await testTables();
            await testStorageBuckets();
            await testRLSPolicies();
            
            addResult('info', '‚úÖ Tests termin√©s!');
        }

        async function testConnection() {
            addResult('info', 'üì° Test de connexion √† Supabase...');
            
            if (!supabase) {
                addResult('error', '‚ùå Client Supabase non initialis√©');
                return false;
            }

            try {
                const { data, error } = await supabase.from('menu_items').select('count', { count: 'exact', head: true });
                
                if (error) {
                    addResult('error', '‚ùå Erreur de connexion: ' + error.message);
                    return false;
                }
                
                addResult('success', '‚úÖ Connexion √† Supabase r√©ussie');
                return true;
            } catch (error) {
                addResult('error', '‚ùå Erreur: ' + error.message);
                return false;
            }
        }

        async function testTables() {
            addResult('info', 'üìä Test des tables...');
            
            const tables = ['menu_items', 'gallery_images', 'orders', 'reservations', 'admin_users'];
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase.from(table).select('count', { count: 'exact', head: true });
                    
                    if (error) {
                        addResult('error', `‚ùå Table "${table}": ${error.message}`);
                    } else {
                        addResult('success', `‚úÖ Table "${table}" existe`);
                    }
                } catch (error) {
                    addResult('error', `‚ùå Table "${table}": ${error.message}`);
                }
            }
        }

        async function testStorageBuckets() {
            addResult('info', 'üíæ Test des buckets de stockage...');
            
            try {
                const { data: buckets, error } = await supabase.storage.listBuckets();
                
                if (error) {
                    addResult('error', '‚ùå Erreur de lecture des buckets: ' + error.message);
                    return false;
                }

                const requiredBuckets = ['restaurant-images', 'payment-proofs'];
                
                for (const bucketName of requiredBuckets) {
                    const bucket = buckets.find(b => b.name === bucketName);
                    if (bucket) {
                        addResult('success', `‚úÖ Bucket "${bucketName}" existe`);
                    } else {
                        addResult('error', `‚ùå Bucket "${bucketName}" n'existe pas`);
                        addResult('info', `üëâ Cr√©ez le bucket "${bucketName}" dans Supabase Storage`);
                    }
                }
            } catch (error) {
                addResult('error', '‚ùå Erreur: ' + error.message);
            }
        }

        async function testRLSPolicies() {
            addResult('info', 'üîí Test des politiques RLS...');
            
            // Test: public peut lire le menu
            try {
                const { data, error } = await supabase.from('menu_items').select('*').limit(1);
                
                if (error) {
                    addResult('error', '‚ùå Policy SELECT sur menu_items: ' + error.message);
                } else {
                    addResult('success', '‚úÖ Policy SELECT sur menu_items fonctionne');
                }
            } catch (error) {
                addResult('error', '‚ùå Policy SELECT sur menu_items: ' + error.message);
            }

            // Test: public peut cr√©er une commande
            addResult('info', 'üß™ Test d\'insertion de commande (sera annul√©e)...');
            try {
                const testOrder = {
                    customer_name: 'Test User',
                    customer_phone: '+509 1234-5678',
                    customer_email: 'test@test.com',
                    items: [{name: 'Test', price: 100, quantity: 1}],
                    total_amount: 100,
                    status: 'pending'
                };

                const { data, error } = await supabase
                    .from('orders')
                    .insert([testOrder])
                    .select();
                
                if (error) {
                    addResult('error', '‚ùå Policy INSERT sur orders: ' + error.message);
                    addResult('error', 'üëâ Ex√©cutez le script supabase-schema.sql pour corriger les politiques');
                } else {
                    addResult('success', '‚úÖ Policy INSERT sur orders fonctionne!');
                    
                    // Supprimer la commande de test (si authentifi√©)
                    if (data && data[0]) {
                        await supabase.from('orders').delete().eq('id', data[0].id);
                        addResult('info', 'üóëÔ∏è Commande de test supprim√©e');
                    }
                }
            } catch (error) {
                addResult('error', '‚ùå Policy INSERT sur orders: ' + error.message);
            }
        }

        async function testStorageUpload() {
            clearResults();
            addResult('info', 'üì§ Test d\'upload d\'image...');
            
            if (!supabase) {
                addResult('error', '‚ùå Client Supabase non initialis√©');
                return;
            }

            try {
                // Cr√©er un petit fichier de test
                const blob = new Blob(['test image content'], { type: 'text/plain' });
                const testFile = new File([blob], 'test.txt', { type: 'text/plain' });
                
                const fileName = `test-${Date.now()}.txt`;
                
                const { data, error } = await supabase.storage
                    .from('restaurant-images')
                    .upload(fileName, testFile);
                
                if (error) {
                    addResult('error', '‚ùå Upload √©chou√©: ' + error.message);
                    
                    if (error.message.includes('not found')) {
                        addResult('error', 'üëâ Le bucket "restaurant-images" n\'existe pas. Cr√©ez-le dans Supabase Storage.');
                    } else if (error.message.includes('policy')) {
                        addResult('error', 'üëâ Les politiques de stockage ne sont pas configur√©es. Ex√©cutez supabase-schema.sql');
                    }
                } else {
                    addResult('success', '‚úÖ Upload r√©ussi!');
                    
                    // Nettoyer
                    await supabase.storage.from('restaurant-images').remove([fileName]);
                    addResult('info', 'üóëÔ∏è Fichier de test supprim√©');
                }
            } catch (error) {
                addResult('error', '‚ùå Erreur: ' + error.message);
            }
        }

        async function testOrderCreation() {
            clearResults();
            addResult('info', 'üõí Test de cr√©ation de commande...');
            
            if (!supabase) {
                addResult('error', '‚ùå Client Supabase non initialis√©');
                return;
            }

            try {
                const testOrder = {
                    customer_name: 'Client Test',
                    customer_phone: '+509 3838-8888',
                    customer_email: 'test@lesillage.ht',
                    delivery_address: '123 Rue Test, Port-au-Prince',
                    items: [
                        { name: 'Griot Traditionnel', price: 850, quantity: 1 },
                        { name: 'Soupe Joumou', price: 650, quantity: 1 }
                    ],
                    total_amount: 1500,
                    status: 'pending',
                    payment_method: 'moncash',
                    notes: 'Commande de test'
                };

                const { data, error } = await supabase
                    .from('orders')
                    .insert([testOrder])
                    .select();
                
                if (error) {
                    addResult('error', '‚ùå Cr√©ation de commande √©chou√©e: ' + error.message);
                    
                    if (error.message.includes('policy')) {
                        addResult('error', 'üëâ Les politiques RLS bloquent l\'insertion. Ex√©cutez supabase-schema.sql');
                        addResult('info', '<div class="code">CREATE POLICY "Public can create orders"<br>ON orders FOR INSERT<br>TO public<br>WITH CHECK (true);</div>');
                    }
                } else {
                    addResult('success', '‚úÖ Commande cr√©√©e avec succ√®s!');
                    addResult('success', `üìù ID de la commande: ${data[0].id}`);
                    
                    // Ne pas supprimer pour que l'admin puisse la voir
                    addResult('info', 'üí° Vous pouvez voir cette commande dans le portail admin');
                }
            } catch (error) {
                addResult('error', '‚ùå Erreur: ' + error.message);
            }
        }

        function addResult(type, message) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = message;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
    </script>
</body>
</html>
